name: New Architecture Gate

on:
  pull_request:
    paths:
      - 'mobile/android/gradle.properties'
      - 'mobile/ios/Podfile'
      - 'mobile/package.json'
  push:
    branches: [main, develop]
    paths:
      - 'mobile/android/gradle.properties'
      - 'mobile/ios/Podfile'
      - 'mobile/package.json'

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  # Detect if newArchEnabled is being changed
  check-new-arch-change:
    name: Check New Architecture Change
    runs-on: ubuntu-latest
    outputs:
      new-arch-enabled: ${{ steps.check.outputs.enabled }}
      new-arch-changed: ${{ steps.check.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check newArchEnabled status
        id: check
        run: |
          CURRENT=$(grep "newArchEnabled" mobile/android/gradle.properties | grep -o "true\|false" || echo "false")
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git checkout ${{ github.event.pull_request.base.sha }}
            PREVIOUS=$(grep "newArchEnabled" mobile/android/gradle.properties | grep -o "true\|false" || echo "false")
            git checkout ${{ github.event.pull_request.head.sha }}
          else
            PREVIOUS=$(git show HEAD~1:mobile/android/gradle.properties 2>/dev/null | grep "newArchEnabled" | grep -o "true\|false" || echo "false")
          fi
          
          echo "enabled=$CURRENT" >> $GITHUB_OUTPUT
          
          if [ "$CURRENT" != "$PREVIOUS" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  New Architecture flag changed from $PREVIOUS to $CURRENT"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

  # Required checks when newArchEnabled changes
  gate-checks:
    name: New Architecture Gate Checks
    runs-on: ubuntu-latest
    needs: check-new-arch-change
    if: needs.check-new-arch-change.outputs.new-arch-changed == 'true'
    strategy:
      fail-fast: false
      matrix:
        check: [compatibility, documentation, tests]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json
      
      - name: Install dependencies
        working-directory: mobile
        run: npm ci
      
      - name: Compatibility Check
        if: matrix.check == 'compatibility'
        working-directory: mobile
        run: |
          echo "## üîç New Architecture Compatibility Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Verify required dependencies
          echo "### Required Dependencies:" >> $GITHUB_STEP_SUMMARY
          
          REANIMATED=$(node -p "require('./package.json').dependencies['react-native-reanimated'] || 'MISSING'")
          if [[ "$REANIMATED" == "3.18.0" ]]; then
            echo "‚úÖ react-native-reanimated: $REANIMATED (compatible)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå react-native-reanimated: $REANIMATED (verify compatibility)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          GESTURE=$(node -p "require('./package.json').dependencies['react-native-gesture-handler'] || 'MISSING'")
          echo "‚úÖ react-native-gesture-handler: $GESTURE" >> $GITHUB_STEP_SUMMARY
          
          FIREBASE=$(node -p "require('./package.json').dependencies['@react-native-firebase/app'] || 'MISSING'")
          if [[ "$FIREBASE" != "MISSING" ]]; then
            echo "‚úÖ @react-native-firebase/app: $FIREBASE" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### React Native Version:" >> $GITHUB_STEP_SUMMARY
          RN_VERSION=$(node -p "require('./package.json').dependencies['react-native']")
          echo "‚úÖ react-native: $RN_VERSION" >> $GITHUB_STEP_SUMMARY
          
          # Check gradle.properties
          if grep -q "newArchEnabled=true" android/gradle.properties; then
            echo "‚úÖ newArchEnabled=true in gradle.properties" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå newArchEnabled not set to true" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          if grep -q "reanimated.newArchEnabled=true" android/gradle.properties; then
            echo "‚úÖ reanimated.newArchEnabled=true in gradle.properties" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è  reanimated.newArchEnabled not explicitly set" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Documentation Check
        if: matrix.check == 'documentation'
        working-directory: mobile
        run: |
          echo "## üìö Documentation Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "docs/NEW_ARCHITECTURE.md" ]; then
            echo "‚úÖ NEW_ARCHITECTURE.md exists" >> $GITHUB_STEP_SUMMARY
            
            # Check for required sections
            if grep -q "## Rollback" docs/NEW_ARCHITECTURE.md; then
              echo "‚úÖ Rollback section found" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå Rollback section missing" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
            
            if grep -q "## Compatibility Checklist" docs/NEW_ARCHITECTURE.md; then
              echo "‚úÖ Compatibility Checklist section found" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå Compatibility Checklist section missing" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "‚ùå NEW_ARCHITECTURE.md not found" >> $GITHUB_STEP_SUMMARY
            echo "Please create documentation at mobile/docs/NEW_ARCHITECTURE.md" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: Tests Check
        if: matrix.check == 'tests'
        working-directory: mobile
        run: |
          echo "## üß™ Tests Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if new architecture tests exist
          if [ -f "src/__tests__/new-architecture.test.tsx" ]; then
            echo "‚úÖ new-architecture.test.tsx exists" >> $GITHUB_STEP_SUMMARY
            
            # Run the new architecture tests
            npm test -- src/__tests__/new-architecture.test.tsx --maxWorkers=2 || {
              echo "‚ùå New architecture tests failed" >> $GITHUB_STEP_SUMMARY
              exit 1
            }
            echo "‚úÖ New architecture tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è  new-architecture.test.tsx not found" >> $GITHUB_STEP_SUMMARY
            echo "Consider adding tests for Fabric/TurboModules features" >> $GITHUB_STEP_SUMMARY
          fi

  # Comment on PR with checklist
  pr-comment:
    name: PR Comment with Checklist
    runs-on: ubuntu-latest
    needs: [check-new-arch-change, gate-checks]
    if: needs.check-new-arch-change.outputs.new-arch-changed == 'true' && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      
      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ‚ö†Ô∏è New Architecture Change Detected
            
            This PR changes the \`newArchEnabled\` flag. Please verify the following before merging:
            
            ### ‚úÖ Pre-merge Checklist
            
            - [ ] All CI checks pass (Android debug/release, iOS Debug/Release)
            - [ ] New architecture tests pass (\`src/__tests__/new-architecture.test.tsx\`)
            - [ ] Native dependencies are compatible (see compatibility check above)
            - [ ] Documentation updated (\`mobile/docs/NEW_ARCHITECTURE.md\`)
            - [ ] Rollback plan documented and tested
            - [ ] Tested on physical devices (Android and iOS if applicable)
            - [ ] No new architecture warnings in build logs
            
            ### üìã Compatibility Status
            
            See the "Compatibility Check" job above for dependency versions.
            
            ### üîÑ Rollback Instructions
            
            If issues are found after merge, set \`newArchEnabled=false\` in \`mobile/android/gradle.properties\` and revert this PR.
            
            See [NEW_ARCHITECTURE.md](../mobile/docs/NEW_ARCHITECTURE.md) for detailed rollback steps.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });


