# Testing Guide: Auth Deletion Retry & Compensating Actions

**Migration:** 2025-10-03_0026  
**Date:** 2025-10-03  
**Purpose:** Validate retry logic and compensating transactions for auth deletion failures

---

## Prerequisites

1. Migration applied: `2025-10-03_0026_auth_deletion_queue_and_compensating_actions.sql`
2. Backend code deployed with `retryService.js`
3. Test user account created
4. API endpoint: `DELETE /api/user/account`

---

## Test Scenarios

### Scenario 1: Normal Deletion (Happy Path)

**Expected:** Auth deletes on first attempt, returns HTTP 200

```bash
# Test command (PowerShell)
$headers = @{
  "Authorization" = "Bearer YOUR_TEST_USER_TOKEN"
  "Content-Type" = "application/json"
}

$body = @{
  confirmDeletion = $true
  reason = "Test scenario 1"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:3000/api/user/account" `
  -Method DELETE `
  -Headers $headers `
  -Body $body
```

**Validation:**
```sql
-- User should be gone from both tables
SELECT * FROM users WHERE email = 'test@example.com';
SELECT * FROM auth_deletion_queue WHERE user_id = '<test_user_id>';

-- Should return: No rows
```

---

### Scenario 2: Transient Error → Successful Retry

**Setup:** Simulate transient error (requires code modification or network interception)

```javascript
// Temporarily modify retryService.js for testing
let attemptCount = 0;
async function testTransientError() {
  attemptCount++;
  if (attemptCount < 3) {
    throw { status: 503, message: 'Service temporarily unavailable' };
  }
  return { success: true };
}
```

**Expected:** 
- First 2 attempts fail with 503
- Third attempt succeeds
- Returns HTTP 200
- Logs show retry attempts

**Validation:**
```bash
# Check backend logs for:
# "Attempt 1 failed, retrying in 1000ms"
# "Attempt 2 failed, retrying in 2000ms"
# "Account deletion completed successfully (3 attempt(s))"
```

---

### Scenario 3: Permanent Failure → Compensating Actions

**Setup:** Simulate auth service failure (requires manual testing with invalid credentials)

Option A: Temporarily break auth by using invalid service role key  
Option B: Use network proxy to intercept and fail auth requests  
Option C: Disable Supabase auth service temporarily

**Expected:**
- 4 attempts fail
- User marked as `auth_deletion_failed`
- Entry created in `auth_deletion_queue`
- Ops alert logged
- Returns HTTP 202 (partial success)

**Response:**
```json
{
  "success": "partial",
  "message": "Database records deleted successfully. Authentication removal is pending manual intervention.",
  "details": {
    "db_deletion": "completed",
    "auth_deletion": "pending",
    "audit_id": "...",
    "queue_id": "...",
    "action_required": "Operations team has been notified..."
  },
  "contact_support": true
}
```

**Validation:**
```sql
-- Check user status
SELECT 
  id, 
  deletion_status, 
  deletion_failed_at, 
  deletion_failure_context 
FROM users 
WHERE id = '<test_user_id>';

-- Expected:
-- deletion_status: 'auth_deletion_failed'
-- deletion_failed_at: <timestamp>
-- deletion_failure_context: { error, attempts, etc. }

-- Check queue
SELECT 
  id,
  user_id,
  operation_type,
  status,
  context,
  last_error,
  retry_count
FROM auth_deletion_queue 
WHERE user_id = '<test_user_id>';

-- Expected:
-- status: 'pending'
-- retry_count: 4
-- context contains full details
```

---

### Scenario 4: Rate Limiting (429 Error)

**Setup:** Trigger rate limit by making multiple deletion requests

**Expected:**
- First few attempts get 429
- System retries with backoff
- Eventually succeeds or queues

**Validation:** Check logs for rate limit handling

---

### Scenario 5: Manual Queue Processing

**Setup:** Create a failed deletion (Scenario 3)

**Steps:**

1. **Check queue:**
   ```sql
   SELECT * FROM failed_auth_deletions_summary;
   ```

2. **Manually delete auth (Supabase dashboard):**
   - Go to Authentication → Users
   - Find user by ID
   - Click "Delete User"

3. **Mark as completed:**
   ```sql
   SELECT update_auth_deletion_queue_status(
     '<queue_id>',
     'completed',
     'Manually resolved in testing',
     'test_operator'
   );
   ```

4. **Verify:**
   ```sql
   SELECT status, completed_at, resolved_by, processing_notes
   FROM auth_deletion_queue
   WHERE id = '<queue_id>';
   
   -- Expected:
   -- status: 'completed'
   -- completed_at: <timestamp>
   -- resolved_by: 'test_operator'
   -- processing_notes: 'Manually resolved in testing'
   ```

---

### Scenario 6: User Already Deleted (404)

**Setup:** Delete auth user first, then trigger deletion endpoint

**Expected:** Should treat 404 as success (idempotent operation)

---

## Monitoring Queries

### Active Failed Deletions
```sql
SELECT 
  user_id,
  last_error,
  retry_count,
  ROUND(EXTRACT(EPOCH FROM (now() - created_at)) / 3600, 2) as hours_pending
FROM auth_deletion_queue
WHERE status = 'pending'
ORDER BY created_at ASC;
```

### Failure Rate Analysis
```sql
SELECT 
  DATE(created_at) as date,
  COUNT(*) as total_attempts,
  COUNT(*) FILTER (WHERE status = 'completed') as successful,
  COUNT(*) FILTER (WHERE status = 'pending') as pending,
  COUNT(*) FILTER (WHERE status = 'failed') as failed
FROM auth_deletion_queue
GROUP BY DATE(created_at)
ORDER BY date DESC;
```

### Retry Distribution
```sql
SELECT 
  retry_count,
  COUNT(*) as count
FROM auth_deletion_queue
GROUP BY retry_count
ORDER BY retry_count;
```

---

## Performance Testing

### Load Test: Multiple Concurrent Deletions

```javascript
// test-concurrent-deletions.js
const users = [...]; // Array of test users
const results = await Promise.allSettled(
  users.map(user => deleteUserAccount(user.token))
);

console.log('Success:', results.filter(r => r.status === 'fulfilled').length);
console.log('Failed:', results.filter(r => r.status === 'rejected').length);
```

**Validate:**
- No race conditions
- All users properly queued if failures occur
- No duplicate queue entries

---

## Cleanup After Testing

```sql
-- Remove test queue entries
DELETE FROM auth_deletion_queue WHERE context->>'deletion_reason' LIKE '%Test scenario%';

-- Check for orphaned test users
SELECT id, email, deletion_status FROM users WHERE email LIKE 'test%';

-- Clean up if needed
DELETE FROM users WHERE email LIKE 'test%' AND deletion_status = 'auth_deletion_failed';
```

---

## Rollback Testing

1. **Create queue entries in test**
2. **Run rollback migration**
3. **Verify all tables/functions removed**
4. **Ensure app still functions (without retry logic)**

---

## Automation Tests (Future)

```javascript
// jest/vitest test suite
describe('Auth Deletion Retry', () => {
  it('should succeed on first attempt', async () => {
    const result = await deleteUser(testUser.id);
    expect(result.status).toBe(200);
    expect(result.success).toBe(true);
  });

  it('should retry on transient error', async () => {
    mockAuthService.mockImplementationOnce(() => 
      Promise.reject({ status: 503 })
    );
    const result = await deleteUser(testUser.id);
    expect(result.attempts).toBeGreaterThan(1);
    expect(result.success).toBe(true);
  });

  it('should queue on permanent failure', async () => {
    mockAuthService.mockRejectedValue({ status: 500 });
    const result = await deleteUser(testUser.id);
    expect(result.status).toBe(202);
    
    const queueItem = await getQueueItem(testUser.id);
    expect(queueItem).toBeDefined();
    expect(queueItem.status).toBe('pending');
  });
});
```

---

## Success Criteria

- ✅ Normal deletions complete in <2 seconds
- ✅ Transient errors automatically retry
- ✅ Permanent failures enqueue within 10 seconds
- ✅ No orphaned auth accounts after DB deletion
- ✅ Ops alerts appear in logs for failures
- ✅ Queue items manually resolvable
- ✅ System remains stable under load
- ✅ No data loss or corruption

---

## Troubleshooting

### Queue Items Not Creating
- Check database permissions
- Verify `auth_deletion_queue` table exists
- Check for errors in `enqueueFailedOperation` function

### Retries Not Working
- Verify transient error detection logic
- Check delay timing in logs
- Ensure `retryWithBackoff` is being called

### Ops Alerts Not Showing
- Check console output
- Verify `sendOpsAlert` is being called
- Future: Check PagerDuty/Slack integration

---

**Last Updated:** 2025-10-03  
**Maintainer:** Development Team

